import { RendererFileSystemService } from "./RendererFileSystemService";
import type { AppSettings } from "../types";

// é»˜è®¤è®¾ç½®
const DEFAULT_SETTINGS: AppSettings = {
    theme: "dark",
    language: "zh",
    autoStart: false,
    minimizeToTray: true,
    devTools: false, // é»˜è®¤å…³é—­å¼€å‘è€…å·¥å…·
    notifications: {
        projectStatus: true,
        errors: true,
        warnings: true,
        updates: false,
        enableSound: true,
        enableDesktop: true,
    },
    projects: {
        defaultPath: "/Users",
        portRange: {
            express: { start: 3000, end: 3099 },
            vite: { start: 5173, end: 5199 },
            other: { start: 8000, end: 8099 },
            auto: true,
        },
        defaultPackageManager: "npm",

        // é¡¹ç›®åˆ›å»ºå’Œç®¡ç†
        creation: {
            autoInstallDeps: true,
            autoOpenBrowser: false,
            autoOpenEditor: true,
            useLatestVersions: false,
            enableTypeScript: true,
            enableESLint: true,
            enablePrettier: true,
            enableGit: true,
            defaultLicense: "MIT",
        },

        // è¿è¡Œæ—¶ç®¡ç†
        runtime: {
            maxConcurrentProjects: 5,
            autoRestartOnCrash: false,
            autoSaveInterval: 30,
            killProcessesOnStop: true,
            watchFileChanges: true,
            hotReload: true,
        },

        // UIå’Œæ˜¾ç¤º
        ui: {
            showProjectThumbnails: true,
            gridView: true,
            showProjectDetails: true,
            compactMode: false,
            sortBy: "lastOpened",
            sortOrder: "desc",
            favoriteProjects: [],
        },

        // Gité›†æˆ
        git: {
            enabled: true,
            autoCommit: false,
            autoCommitMessage: "Auto-commit: {{timestamp}}",
            showBranchInProjectCard: true,
            showUncommittedChanges: true,
            defaultBranch: "main",
        },

        // Dockeræ”¯æŒ
        docker: {
            enabled: false,
            autoDetectDockerfile: true,
            defaultBaseImage: "node:18-alpine",
            autoGenerateDockerfile: false,
            exposePortsAutomatically: true,
        },

        // ç»ˆç«¯é›†æˆ
        terminal: {
            enabled: true,
            defaultShell: "zsh",
            preserveHistory: true,
            maxHistorySize: 1000,
            customCommands: [
                {
                    name: "æ¸…ç†ç¼“å­˜",
                    command: "npm cache clean --force",
                    description: "æ¸…ç†npmç¼“å­˜",
                },
                {
                    name: "æ£€æŸ¥ç«¯å£å ç”¨",
                    command: "lsof -i :{{port}}",
                    description: "æ£€æŸ¥æŒ‡å®šç«¯å£çš„å ç”¨æƒ…å†µ",
                },
            ],
        },

        // æ€§èƒ½ç›‘æ§
        monitoring: {
            enabled: true,
            realTimeMonitoring: true,
            logRetentionDays: 7,
            autoCleanupLogs: true,
            alertOnHighCPU: true,
            alertOnHighMemory: true,
            cpuThreshold: 80,
            memoryThreshold: 1024,
            trackProjectMetrics: true,
            enableErrorTracking: true,
        },

        // å¤‡ä»½ç³»ç»Ÿ
        backup: {
            enabled: false,
            autoBackup: false,
            backupInterval: 24,
            maxBackups: 5,
            backupPath: "~/Projects/Backups",
            includeNodeModules: false,
            includeGitHistory: true,
            compressBackups: true,
            excludePatterns: ["node_modules", ".git", "dist", "build", ".cache"],
        },

        // ç¼–è¾‘å™¨é›†æˆ
        editor: {
            defaultEditor: "vscode",
            customEditorCommand: "",
            openProjectOnCreate: true,
            openSpecificFiles: true,
            defaultFilesToOpen: ["README.md", "package.json", "src/index.ts"],
            enableEditorSync: false,
        },

        // ä¾èµ–ç®¡ç†
        dependencies: {
            autoUpdate: false,
            updateFrequency: "weekly",
            checkSecurity: true,
            autoFixVulnerabilities: false,
            showOutdatedPackages: true,
            licenseChecking: false,
        },

        // æ¨¡æ¿å’Œè„šæ‰‹æ¶
        templates: {
            customTemplatesPath: "~/Projects/Templates",
            favoriteTemplates: ["full-stack", "pure-api"],
            enableRemoteTemplates: true,
            templateSources: [
                {
                    name: "Official Templates",
                    url: "https://github.com/node-templates/official",
                    enabled: true,
                },
            ],
        },

        // å›¢é˜Ÿåä½œ
        collaboration: {
            enableTeamFeatures: false,
            shareProjects: false,
            syncSettings: false,
            teamWorkspacePath: "~/Team/Projects",
        },

        // æ’ä»¶ç³»ç»Ÿ
        plugins: {
            enabled: false,
            autoUpdate: true,
            allowThirdParty: false,
            pluginDirectory: "~/NodeAppManager/Plugins",
            installedPlugins: [],
        },
    },
};

/**
 * è®¾ç½®æœåŠ¡ç±»
 * è´Ÿè´£ç®¡ç†åº”ç”¨è®¾ç½®çš„è¯»å–ã€ä¿å­˜å’Œæ›´æ–°
 */
export class SettingsService {
    private static cachedSettings: AppSettings | null = null;

    /**
     * è¿ç§»æ—§è®¾ç½®æ ¼å¼åˆ°æ–°æ ¼å¼
     */
    private static migrateOldSettings(oldSettings: any): AppSettings {
        // å¦‚æœå·²ç»æ˜¯æ–°æ ¼å¼ï¼Œç›´æ¥è¿”å›
        if (oldSettings.projects && typeof oldSettings.projects === "object" && oldSettings.projects.creation) {
            return { ...DEFAULT_SETTINGS, ...oldSettings };
        }

        // å¤„ç†æ—§æ ¼å¼çš„projectsè®¾ç½®
        const newSettings: AppSettings = { ...DEFAULT_SETTINGS };

        // åŸºæœ¬è®¾ç½®è¿ç§»
        if (oldSettings.theme) newSettings.theme = oldSettings.theme;
        if (oldSettings.language) newSettings.language = oldSettings.language;
        if (oldSettings.autoStart !== undefined) newSettings.autoStart = oldSettings.autoStart;
        if (oldSettings.minimizeToTray !== undefined) newSettings.minimizeToTray = oldSettings.minimizeToTray;
        if (oldSettings.devTools !== undefined) newSettings.devTools = oldSettings.devTools;

        // é€šçŸ¥è®¾ç½®è¿ç§»
        if (oldSettings.notifications) {
            newSettings.notifications = { ...DEFAULT_SETTINGS.notifications, ...oldSettings.notifications };
        }

        // é¡¹ç›®è®¾ç½®è¿ç§»
        if (oldSettings.projects) {
            const oldProjects = oldSettings.projects;

            // åŸºæœ¬é¡¹ç›®è®¾ç½®
            if (oldProjects.defaultPath) newSettings.projects.defaultPath = oldProjects.defaultPath;
            if (oldProjects.defaultPackageManager) newSettings.projects.defaultPackageManager = oldProjects.defaultPackageManager;
            if (oldProjects.portRange) newSettings.projects.portRange = { ...DEFAULT_SETTINGS.projects.portRange, ...oldProjects.portRange };

            // è¿ç§»æ—§çš„æ‰å¹³è®¾ç½®åˆ°æ–°çš„åˆ†ç»„ç»“æ„
            if (oldProjects.autoInstallDeps !== undefined) {
                newSettings.projects.creation.autoInstallDeps = oldProjects.autoInstallDeps;
            }
            if (oldProjects.autoOpenBrowser !== undefined) {
                newSettings.projects.creation.autoOpenBrowser = oldProjects.autoOpenBrowser;
            }
            if (oldProjects.maxConcurrentProjects !== undefined) {
                newSettings.projects.runtime.maxConcurrentProjects = oldProjects.maxConcurrentProjects;
            }
            if (oldProjects.autoSaveInterval !== undefined) {
                newSettings.projects.runtime.autoSaveInterval = oldProjects.autoSaveInterval;
            }
            if (oldProjects.showProjectThumbnails !== undefined) {
                newSettings.projects.ui.showProjectThumbnails = oldProjects.showProjectThumbnails;
            }
            if (oldProjects.gitIntegration !== undefined) {
                newSettings.projects.git.enabled = oldProjects.gitIntegration;
            }
            if (oldProjects.dockerSupport !== undefined) {
                newSettings.projects.docker.enabled = oldProjects.dockerSupport;
            }
        }

        // ç»ˆç«¯è®¾ç½®è¿ç§»
        if (oldSettings.terminalIntegration || oldSettings.terminal) {
            const terminalSettings = oldSettings.terminalIntegration || oldSettings.terminal;
            if (terminalSettings.enabled !== undefined) {
                newSettings.projects.terminal.enabled = terminalSettings.enabled;
            }
            if (terminalSettings.defaultShell) {
                newSettings.projects.terminal.defaultShell = terminalSettings.defaultShell;
            }
            if (terminalSettings.preserveHistory !== undefined) {
                newSettings.projects.terminal.preserveHistory = terminalSettings.preserveHistory;
            }
        }

        // ç›‘æ§è®¾ç½®è¿ç§»
        if (oldSettings.monitoring) {
            const monitoring = oldSettings.monitoring;
            if (monitoring.enablePerformanceMonitoring !== undefined) {
                newSettings.projects.monitoring.enabled = monitoring.enablePerformanceMonitoring;
            }
            if (monitoring.logRetentionDays !== undefined) {
                newSettings.projects.monitoring.logRetentionDays = monitoring.logRetentionDays;
            }
            if (monitoring.autoCleanupLogs !== undefined) {
                newSettings.projects.monitoring.autoCleanupLogs = monitoring.autoCleanupLogs;
            }
            if (monitoring.alertOnHighCPU !== undefined) {
                newSettings.projects.monitoring.alertOnHighCPU = monitoring.alertOnHighCPU;
            }
            if (monitoring.alertOnHighMemory !== undefined) {
                newSettings.projects.monitoring.alertOnHighMemory = monitoring.alertOnHighMemory;
            }
            if (monitoring.cpuThreshold !== undefined) {
                newSettings.projects.monitoring.cpuThreshold = monitoring.cpuThreshold;
            }
            if (monitoring.memoryThreshold !== undefined) {
                newSettings.projects.monitoring.memoryThreshold = monitoring.memoryThreshold;
            }
        }

        // å¤‡ä»½è®¾ç½®è¿ç§»
        if (oldSettings.backup) {
            newSettings.projects.backup = { ...DEFAULT_SETTINGS.projects.backup, ...oldSettings.backup };
        }

        // ç¼–è¾‘å™¨è®¾ç½®è¿ç§»
        if (oldSettings.editor) {
            newSettings.projects.editor = { ...DEFAULT_SETTINGS.projects.editor, ...oldSettings.editor };
        }

        return newSettings;
    }

    /**
     * åŠ è½½è®¾ç½®
     */
    static async loadSettings(): Promise<AppSettings> {
        try {
            // å¼ºåˆ¶é‡æ–°åŠ è½½ï¼Œæ¸…é™¤ç¼“å­˜ï¼ˆä¸´æ—¶ä¿®å¤ï¼‰
            this.cachedSettings = null;
            console.log("åŠ è½½è®¾ç½®...");
            // æ£€æŸ¥æ˜¯å¦åœ¨Electronç¯å¢ƒä¸­
            if (RendererFileSystemService.isInElectron()) {
                const result = await window.electronAPI!.invoke("settings:load");

                if (result.success && result.data) {
                    const settings = result.data;
                    // ä½¿ç”¨è¿ç§»å‡½æ•°å¤„ç†å¯èƒ½çš„æ—§æ ¼å¼è®¾ç½®
                    const migratedSettings = this.migrateOldSettings(settings);
                    this.cachedSettings = migratedSettings;
                    return this.cachedSettings;
                }
            } else {
                // åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨localStorageä½œä¸ºé™çº§æ–¹æ¡ˆ
                const stored = localStorage.getItem("app-settings");
                if (stored) {
                    const settings = JSON.parse(stored);
                    // ä½¿ç”¨è¿ç§»å‡½æ•°å¤„ç†å¯èƒ½çš„æ—§æ ¼å¼è®¾ç½®
                    const migratedSettings = this.migrateOldSettings(settings);
                    this.cachedSettings = migratedSettings;
                    return this.cachedSettings;
                }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è®¾ç½®æ–‡ä»¶ï¼Œè¿”å›é»˜è®¤è®¾ç½®
            this.cachedSettings = DEFAULT_SETTINGS;
            return this.cachedSettings;
        } catch (error) {
            console.error("åŠ è½½è®¾ç½®å¤±è´¥:", error);
            this.cachedSettings = DEFAULT_SETTINGS;
            return this.cachedSettings;
        }
    }

    /**
     * ä¿å­˜è®¾ç½®
     */
    static async saveSettings(settings: AppSettings): Promise<boolean> {
        try {
            // æ›´æ–°ç¼“å­˜
            this.cachedSettings = settings;
            console.log("ä¿å­˜è®¾ç½®");
            // æ£€æŸ¥æ˜¯å¦åœ¨Electronç¯å¢ƒä¸­
            if (RendererFileSystemService.isInElectron()) {
                const result = await window.electronAPI!.invoke("settings:save", settings);
                return result.success;
            } else {
                // åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨localStorageä½œä¸ºé™çº§æ–¹æ¡ˆ
                localStorage.setItem("app-settings", JSON.stringify(settings));
                return true;
            }
        } catch (error) {
            console.error("ä¿å­˜è®¾ç½®å¤±è´¥:", error);
            return false;
        }
    }

    /**
     * æ›´æ–°ç‰¹å®šè®¾ç½®é¡¹
     */
    static async updateSetting<K extends keyof AppSettings>(key: K, value: AppSettings[K]): Promise<boolean> {
        try {
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„è®¾ç½®ï¼Œé¿å…é‡å¤åŠ è½½
            let currentSettings = this.cachedSettings;

            // åªæœ‰åœ¨ç¼“å­˜ä¸å­˜åœ¨æ—¶æ‰åŠ è½½
            if (!currentSettings) {
                console.log("âš ï¸ è®¾ç½®ç¼“å­˜ä¸ºç©ºï¼Œé‡æ–°åŠ è½½è®¾ç½®...");
                currentSettings = await this.loadSettings();
            }

            // æ›´æ–°è®¾ç½®
            const newSettings = { ...currentSettings, [key]: value };
            const success = await this.saveSettings(newSettings);

            if (success) {
                // æ›´æ–°ç¼“å­˜
                this.cachedSettings = newSettings;
                console.log(`âœ… è®¾ç½®é¡¹ "${String(key)}" å·²æ›´æ–°ä¸º:`, value);
            }

            return success;
        } catch (error) {
            console.error("æ›´æ–°è®¾ç½®å¤±è´¥:", error);
            return false;
        }
    }

    /**
     * é‡ç½®ä¸ºé»˜è®¤è®¾ç½®
     */
    static async resetToDefaults(): Promise<boolean> {
        try {
            console.log("é‡ç½®è®¾ç½®ä¸ºé»˜è®¤å€¼");
            this.cachedSettings = null;
            return await this.saveSettings(DEFAULT_SETTINGS);
        } catch (error) {
            console.error("é‡ç½®è®¾ç½®å¤±è´¥:", error);
            return false;
        }
    }

    /**
     * è·å–é»˜è®¤è®¾ç½®
     */
    static getDefaultSettings(): AppSettings {
        return { ...DEFAULT_SETTINGS };
    }

    /**
     * éªŒè¯è®¾ç½®æœ‰æ•ˆæ€§
     */
    static validateSettings(settings: any): settings is AppSettings {
        try {
            return typeof settings === "object" && settings !== null && ["dark", "light"].includes(settings.theme) && ["zh", "en"].includes(settings.language) && typeof settings.autoStart === "boolean" && typeof settings.minimizeToTray === "boolean" && typeof settings.notifications === "object" && typeof settings.projects === "object";
        } catch {
            return false;
        }
    }
}
